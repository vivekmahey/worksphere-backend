<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkSphere</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.css" rel="stylesheet">
  <style>
    .grid-cols-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 1rem; }
    .hover\\:scale-105:hover { transform: scale(1.05); transition: 0.2s; }
    #luckysheet { width: 100%; height: 600px; }
    .ql-editor { min-height: 400px; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <div id="root"></div>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Luckysheet -->
  <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Your App Code -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const Editor = ({ tab, index, onClose }) => {
      const containerRef = useRef(null);
      const quillRef = useRef(null);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        if (!tab.fileData) return;

        if (tab.type === 'excel') {
          // Decode XLSX from Buffer
          const binary = atob(tab.fileData.split(',')[1]);
          const len = binary.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);

          const workbook = XLSX.read(bytes, { type: 'array' });
          const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });

          luckysheet.create({
            container: containerRef.current,
            data: [{ name: tab.name, celldata: sheetData.map((row, r) => row.map((cell, c) => ({ r, c, v: { v: cell } }))) }],
            title: tab.name,
          });
        }

        if (tab.type === 'docs') {
          const quill = new Quill(quillRef.current, {
            theme: 'snow',
            modules: { toolbar: true },
          });

          // Try to extract text from DOCX (simplified)
          const text = tab.fileData.includes('word/document.xml')
            ? 'DOCX parsing not supported in browser. Raw file stored.'
            : atob(tab.fileData.split(',')[1]);

          quill.setText(text);
        }
      }, [tab]);

      const save = async () => {
        setSaving(true);
        try {
          const payload = { index, updates: {} };
          if (tab.type === 'excel') {
            const data = luckysheet.getAllSheets();
            payload.updates.fileData = data;
          }
          if (tab.type === 'docs') {
            payload.updates.text = quillRef.current.__quill.getText();
          }

          await fetch(`/api/tabs/${index}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          alert('Saved!');
        } catch (err) {
          alert('Save failed');
        }
        setSaving(false);
      };

      return (
        <div className="p-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-2xl font-bold">{tab.name}</h2>
            <div className="flex gap-2">
              <button onClick={save} disabled={saving} className="bg-green-600 px-4 py-2 rounded">
                {saving ? 'Saving...' : 'Save'}
              </button>
              <button onClick={onClose} className="bg-gray-600 px-4 py-2 rounded">Close</button>
            </div>
          </div>

          {tab.type === 'excel' && <div ref={containerRef}></div>}
          {tab.type === 'docs' && <div ref={quillRef}></div>}
          {tab.type === 'powerpoint' && (
            <div className="text-center">
              <p>PowerPoint preview coming soon</p>
              <a href={`/api/tabs/${index}/file`} target="_blank" className="text-blue-400 underline">Download PPTX</a>
            </div>
          )}
        </div>
      );
    };

    const AddTabModal = ({ isOpen, setIsOpen }) => {
      const [name, setName] = useState('');
      const [type, setType] = useState('excel');
      const [file, setFile] = useState(null);
      const [error, setError] = useState(null);
      const [uploading, setUploading] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        setError(null);
        setUploading(true);

        const formData = new FormData();
        formData.append('name', name);
        formData.append('type', type);
        if (file) formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/tabs', true);
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            setIsOpen(false);
            setName(''); setType('excel'); setFile(null);
            window.location.reload();
          } else setError(`Error: ${xhr.status}`);
          setUploading(false);
        };
        xhr.onerror = () => { setError('Network error'); setUploading(false); };
        xhr.send(formData);
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-gray-800 p-6 rounded-lg w-96">
            <h2 className="text-xl mb-4">Add New Tab</h2>
            {error && <div className="text-red-500 mb-4 p-2 bg-red-100 rounded">{error}</div>}
            <form onSubmit={handleSubmit}>
              <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Tab Name" className="w-full bg-gray-700 p-2 rounded mb-4 text-white" required />
              <select value={type} onChange={e => setType(e.target.value)} className="w-full bg-gray-700 p-2 rounded mb-4 text-white">
                <option value="excel">Excel</option>
                <option value="powerpoint">PowerPoint</option>
                <option value="docs">Documents</option>
                <option value="notes">Notes</option>
                <option value="code">Code</option>
                <option value="web">Web Research</option>
              </select>
              <input type="file" onChange={e => setFile(e.target.files[0])} accept=".xlsx,.xls,.pptx,.docx,.pdf" className="w-full bg-gray-700 p-2 rounded mb-4" />
              <div className="flex justify-end gap-2">
                <button type="button" onClick={() => setIsOpen(false)} className="bg-gray-600 text-white py-2 px-4 rounded">Cancel</button>
                <button type="submit" disabled={uploading} className={`py-2 px-4 rounded text-white ${uploading ? 'bg-blue-400 opacity-50' : 'bg-blue-500 hover:bg-blue-600'}`}>
                  {uploading ? 'Uploading...' : 'Add'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    const App = () => {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [tabs, setTabs] = useState([]);
      const [selectedTab, setSelectedTab] = useState(null);

      const fetchTabs = () => {
        fetch('/api/tabs')
          .then(res => res.json())
          .then(data => setTabs(Array.isArray(data) ? data : []))
          .catch(() => setTabs([]));
      };

      useEffect(() => {
        fetchTabs();
        const ws = new WebSocket('ws://localhost:5000');
        ws.onmessage = (e) => { if (e.data === 'tab-updated') fetchTabs(); };
        return () => ws.close();
      }, []);

      const deleteTab = (index) => {
        fetch(`/api/tabs/${index}`, { method: 'DELETE' }).then(fetchTabs);
      };

      return (
        <div className="flex h-screen">
          <div className="w-64 bg-gray-800 p-4">
            <button onClick={() => setIsModalOpen(true)} className="w-full bg-blue-600 text-white py-2 rounded mb-4">+ Add Tab</button>
            <div className="space-y-2">
              {tabs.map((tab, i) => (
                <div key={i} className="bg-gray-700 p-3 rounded flex justify-between items-center">
                  <div onClick={() => setSelectedTab({ ...tab, index: i })} className="cursor-pointer">
                    <div className="font-bold">{tab.name}</div>
                    <div className="text-sm">{tab.type}</div>
                  </div>
                  <button onClick={() => deleteTab(i)} className="text-red-400 hover:text-red-500">X</button>
                </div>
              ))}
            </div>
          </div>

          <div className="flex-1 p-6 overflow-auto">
            {selectedTab ? (
              <Editor tab={selectedTab} index={selectedTab.index} onClose={() => setSelectedTab(null)} />
            ) : (
              <div className="grid-cols-3">
                {tabs.length === 0 ? (
                  <h2 className="text-2xl">No tabs yet - Add one!</h2>
                ) : (
                  tabs.map((tab, i) => (
                    <div key={i} onClick={() => setSelectedTab({ ...tab, index: i })} className="p-4 bg-gray-800 rounded-lg hover:scale-105 cursor-pointer">
                      <h3 className="text-lg font-bold">{tab.name}</h3>
                      <p>Type: {tab.type}</p>
                      {tab.fileData && <p className="text-green-400">File attached</p>}
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          <AddTabModal isOpen={isModalOpen} setIsOpen={setIsModalOpen} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>